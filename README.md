# Aggregator Service

Сервис агрегирует измерения из пакетов, используя генератор и пул воркеров.

## Мониторинг

Для локального запуска системы мониторинга используйте docker-compose:

```bash
docker-compose up
```

После запуска доступны следующие эндпоинты:

- Grafana: http://localhost:3000
- Prometheus: http://localhost:9090
- Метрики сервиса: http://localhost:2112/metrics
- Health-check: http://localhost:8080/health

## Архитектура проекта

```
aggregator-service/
├── app/
│   ├── cmd/                 # точка входа приложения
│   ├── proto/               # gRPC контракты
│   ├── src/
│   │   ├── api/             # HTTP и gRPC транспорты
│   │   ├── core/            # бизнес-логика и use-case'ы
│   │   ├── domain/          # доменные модели и интерфейсы
│   │   ├── infra/           # инфраструктурные адаптеры (config, metrics, db)
│   │   └── shared/          # общие константы и ошибки
│   └── tests/               # unit / integration / e2e тесты
├── cmd/migrate              # простая утилита применения SQL миграций
├── docker-compose.yml
├── Dockerfile
└── Makefile
```

## Работа с зависимостями Go

Проект использует официальные реализации `google.golang.org/grpc`, `google.golang.org/protobuf`
и `github.com/lib/pq`. Если стандартный прокси Go (`proxy.golang.org`) недоступен и команды
`go mod tidy`, `go build` или `go test` завершаются ошибкой `HTTP 403`, выполните один из
вариантов ниже:

1. Запускайте команды с прямым доступом к исходным репозиториям:

   ```bash
   GOPROXY=direct go mod tidy
   GOPROXY=direct go test ./...
   ```

   Аналогично работают цели `make`: по умолчанию они выполняются с `GOPROXY=direct`, однако
   при необходимости можно переопределить прокси:

   ```bash
   GOPROXY=https://proxy.golang.org,direct make build
   ```

2. Чтобы сохранить настройку между сессиями, используйте `go env`:

   ```bash
   go env -w GOPROXY=direct
   ```

3. Если прямой доступ к доменам `google.golang.org` или `github.com` ограничен, задайте
   альтернативное зеркало прокси (например, `https://goproxy.io`) либо используйте VPN.

После загрузки зависимостей не забудьте выполнить `go mod tidy` — он добавит контрольные
суммы в `go.sum`.

## Оффлайн-сборка

Для повторяемых сборок без доступа в интернет зависимости фиксируются в каталоге `vendor/`.
Алгоритм обновления следующий:

1. Убедитесь, что временно доступны внешние репозитории, и скачайте зависимости:

   ```bash
   go mod tidy
   ```

2. Сохраните их локально:

   ```bash
   go mod vendor
   ```

3. Закоммитьте обновлённый каталог `vendor/` вместе с изменёнными `go.mod` и `go.sum`.

Цели `make build` и `make test` теперь используют ключ `-mod=vendor` и переменные окружения
`GOPROXY=off GOSUMDB=off`, поэтому при наличии каталога `vendor/` все команды выполняются
исключительно на локальных копиях пакетов.

## Конфигурация

Основные параметры приложения считываются из файла `.env`:

- `N` — интервал генератора в миллисекундах (например, `1000` для 1 секунды).
- `K` — количество измерений в одном пакете (`256` по умолчанию).
- `M` — размер пула воркеров (`4` по умолчанию).
- `PACKET_BUFFER` — емкость буфера пакетов между генератором и обработчиками (`100`).

Для совместимости с другими компонентами рядом остаются переменные `GEN_K`, `GEN_N` и `WORKER_POOL_SIZE`. Их значения синхронизированы с новыми ключами и позволяют модулю `aggregator` продолжать использовать прежние имена.

## Manual E2E test

```bash
make run              # запустить миграции + сервис (:8080) + экспортер (:2112)
make test-flow        # выполнить минимальный e2e health-check сценарий
make test-integration # вручную запустить интеграционные тесты (требуется Docker/Postgres)
```
